---
title: "Preparing Data for Constructing Diversification Measures (eg, MS = 1 if a multiple-segment firm)"
output:
  html_notebook: default
  # html_document: default
  # word_document: default
---


# Load required library and the data
```{r}

# '#' indcates the beginning of a comment (ignored by R) to annotate code lines
# It is also a convenient way to deactivate a code line when you change your mind and want to exclude it


# Below loads the required libraries
#library(magrittr)
library(tidyverse)
library(lubridate)

segmData_file = 'compsegd_1990_1991.csv'

# Below sets changeable parameters for the path of the cleaned data file
mainDir = ''  
subDir = ''  

###################################################################################
# Read in raw segment data
rawData <- read.csv(paste0(mainDir, subDir, segmData_file)) %>% 
    mutate(
      datadate_int = datadate, # keep a copy of the original integer format
      srcdate_int = srcdate,
      datadate = ymd(datadate), # convert to Date format
      srcdate = ymd(srcdate),
      )

# change all column variable names to lowercase
names(rawData) <- tolower(names(rawData))
###################################################################################


# earliest = "1990-01-01" #"1998-01-01" 
# lastdate = "1999-12-31"    #"1999-12-31"
rawData %>% 
  saveRDS(paste0(mainDir, subDir, "segmentHist_raw", 'Example.rds'))

```


# Data integrity checks: Remove problematic observations (eg, gvkey-datadate obs. with missing-value sics1, etc)
```{r}

# earliest = "1990-01-01" #"1998-01-01" 
# lastdate = "1999-12-31"    #"1999-12-31"

data_cleaned <- rawData %>% 
  mutate(dyear = year(datadate), dmonth = month(datadate), dday = day(datadate),
         syear = year(srcdate), smonth = month(srcdate), sday = day(srcdate),
         ) %>% 
  #=========================================================
  # upds = 2 means newswire, incomplete, trading suspended, etc; = 1 means only market data, csho 
  filter(upds == 3 & !is.na(upds)) %>% # = 3 means final
############################################################### <--------------------------------- !!!  
  mutate(rm_flag = FALSE) %>% # set initial value of rm_flag (ie, by default, do not remove)
################################################################################################
  mutate(snms = tolower(snms)) %>% # standardize segment name to lowercase
  # convert sics's to integer type to be consistent with sich
  mutate_at(vars(starts_with("sics")), ~ as.integer(.)) %>%  
  # Create sics_my to allow for the possibility of later classifying undesirable cases into
  #   negative-value categories (eg, -6666 for "undesirable" financial segment)
  mutate(sics_my = sics1) %>% 
################################################################################################
  select(everything())  

```


# Data integrity checks: Prelim look of categorical data and summary of continuous variables
```{r}

facVars <- "dmonth, smonth, dday, sday, srcs, upds, stype, sid, soptp1, soptp2, geotp, curcds, isosrc" %>%  
  str_split(", ", simplify = TRUE) %>% 
  c()

# Prelim look of various categorical variables
data_cleaned %>% 
  # turn the following into factors only for the purpose of examining the categorical and continuous variables
  mutate_at(vars(facVars), ~ as.factor(.)) %>% 
  select(datadate, srcdate, 
         dyear, syear, dmonth, smonth, dday, sday, 
         srcs, upds, stype, sid, 
         rm_flag, soptp1, soptp2, geotp, curcds, isosrc
         ) %>% 
  summary()


cat("\n\nsummary of continuous variables:\n\n")
data_cleaned %>%
  select(-facVars) %>% 
  select_if(is.numeric) %>%
  summary() %>% 
  print()

```


# Data integrity checks: Confirm no duplicate sid for each gvkey-datadate (or gvkey-dyear-dmonth)
```{r}

# no duplicate for each (gvkey, datadate, sid)
data_cleaned %>% 
  group_by(gvkey, datadate, sid) %>% 
  filter(n() > 1) %>% 
  nrow() 
# Expecting 0 found 


# no duplicate for each (gvkey, dyear, dmonth, sid)
data_cleaned %>% 
  group_by(gvkey, dyear, dmonth, sid) %>% 
  filter(n() > 1) %>% 
  nrow() 
# Expecting 0 found 


#==========================================================
# duplicates for each (gvkey, [dyear], sid) due to change of FYE or segment name/structure
data_cleaned %>% 
  group_by(
    stype,  
    gvkey, dyear, sid) %>% 
  filter(n() > 2) %>%
  nrow()
# Expecting 0 found for n() > 2 (assuming n() = 2 caused by change of FYE only)

```


# Save cleaned data for further processing and regression analysis
```{r}

saveRDS(data_cleaned, file = paste0(mainDir, subDir, "segmentHist_clean", 'Example.rds'))

```



